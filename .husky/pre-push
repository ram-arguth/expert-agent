#!/usr/bin/env sh

# Pre-push checks - ensures code passes CI checks before pushing
echo "üîó Running pre-push checks..."

# 1. Run a production build to catch build errors
# This is the most important check to prevent Cloud Build failures
echo "üèóÔ∏è  Running production build..."
if ! pnpm build 2>&1 | tail -20; then
  echo "‚ùå Build failed! Please fix build errors before pushing."
  exit 1
fi
echo "‚úÖ Build passed!"

# 2. Run integration tests (skip if no database available)
echo "üîó Running integration tests..."
# Integration tests require PostgreSQL - skip if not running
# The tests will fully run in CI where database is available
pnpm test:integration -- --run 2>&1 || {
  if echo "$?" | grep -q "Can't reach database"; then
    echo "‚ö†Ô∏è  Integration tests skipped - no database available (will run in CI)"
  else
    echo "‚ö†Ô∏è  Integration tests skipped - run locally with PostgreSQL"
  fi
}

echo "‚úÖ All pre-push checks passed!"
